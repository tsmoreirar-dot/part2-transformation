create or replace table enrich_url_params_and_7d_attribution as(
WITH kv AS (
    -- Extract key-value pairs from the URL query string
    SELECT
        event_id,
        page_url,
        SPLIT_PART(pair, '=', 1) AS key,
        SPLIT_PART(pair, '=', 2) AS value
    FROM (
        SELECT
            event_id,
            page_url,
            UNNEST(STRING_SPLIT(SPLIT_PART(page_url, '?', 2), '&')) AS pair
        FROM enrich_session_and_event_id
    )
),
events_with_extracted_url_params AS (
    -- Pivot the key-value pairs to extract URL parameters and calculate traffic_channel
    SELECT
        event_id,
        page_url,
        -- UTM parameters
        MAX(CASE WHEN key = 'utm_campaign' THEN value END) AS utm_campaign,
        MAX(CASE WHEN key = 'utm_content' THEN value END) AS utm_content,
        MAX(CASE WHEN key = 'utm_medium' THEN value END) AS utm_medium,
        MAX(CASE WHEN key = 'utm_source' THEN value END) AS utm_source,
        MAX(CASE WHEN key = 'utm_term' THEN value END) AS utm_term,
        -- Paid/Tracking IDs
        MAX(CASE WHEN key = 'gclid' THEN value END) AS gclid,
        MAX(CASE WHEN key = 'gad_source' THEN value END) AS gad_source,
        MAX(CASE WHEN key = 'gbraid' THEN value END) AS gbraid,
        MAX(CASE WHEN key = '_gl' THEN value END) AS _gl,
        MAX(CASE WHEN key = 'fbclid' THEN value END) AS fbclid,
        MAX(CASE WHEN key = 'msclkid' THEN value END) AS msclkid,
        MAX(CASE WHEN key = 'irclickid' THEN value END) AS irclickid,
        MAX(CASE WHEN key = 'irgwc' THEN value END) AS irgwc,
        MAX(CASE WHEN key = 'iradid' THEN value END) AS iradid,
        MAX(CASE WHEN key = 'im_ref' THEN value END) AS im_ref,
        MAX(CASE WHEN key = 'oid' THEN value END) AS oid,
        MAX(CASE WHEN key = 'affid' THEN value END) AS affid,
        MAX(CASE WHEN key = 'sub1' THEN value END) AS sub1,
        MAX(CASE WHEN key = 'sub2' THEN value END) AS sub2,
        MAX(CASE WHEN key = 'sub3' THEN value END) AS sub3,
        MAX(CASE WHEN key = 'clickid' THEN value END) AS clickid,
        MAX(CASE WHEN key = 'sharedid' THEN value END) AS sharedid,
        MAX(CASE WHEN key = 'sfdr_ptcid' THEN value END) AS sfdr_ptcid,
        MAX(CASE WHEN key = 'sfdr_hash' THEN value END) AS sfdr_hash,
        MAX(CASE WHEN key = '_kx' THEN value END) AS _kx,
        MAX(CASE WHEN key = 'bxid' THEN value END) AS bxid,
        MAX(CASE WHEN key = 'amp_device_id' THEN value END) AS amp_device_id,
        MAX(CASE WHEN key = 'locale' THEN value END) AS locale,
        -- traffic_channel calculation
        CASE
            WHEN MAX(CASE WHEN key = 'msclkid' THEN value END) IS NOT NULL THEN 'bing'
            WHEN MAX(CASE WHEN key IN ('gclid','gbraid','gad_source') THEN value END) IS NOT NULL THEN 'google'
            WHEN MAX(CASE WHEN key = 'fbclid' THEN value END) IS NOT NULL THEN 'meta'
            WHEN MAX(CASE WHEN key IN ('affid','oid','sub1','irclickid','iradid','irgwc','im_ref','sfdr_ptcid') THEN value END) IS NOT NULL THEN 'affiliates'
            WHEN MAX(CASE WHEN key IN ('_kx','bxid') THEN value END) IS NOT NULL THEN 'other - investigate'
            ELSE 'organic'
        END AS traffic_channel
    FROM kv
    GROUP BY event_id, page_url
),
events_ts AS (
    -- FIX APPLIED HERE: Use EPOCH_MS() to convert the TIMESTAMP WITH TIME ZONE column to BIGINT milliseconds
    SELECT
        e.*,
        TIMESTAMP '1970-01-01 00:00:00' + INTERVAL '1 second' * (EPOCH_MS(e.timestamp) / 1000) AS ts
    FROM enrich_session_and_event_id e
),
events_enriched AS (
    -- Combine original event data with extracted params and traffic channel
    SELECT
        t1.event_id,
        t1.client_id,
        t1.ts,
        t2.traffic_channel
    FROM events_ts t1
    JOIN events_with_extracted_url_params t2
        ON t1.event_id = t2.event_id
),
event_windows AS (
    -- Build a flattened table of all events per client within 7 days of each target event (e)
    SELECT
        e.event_id AS e_id,
        t.traffic_channel,
        t.ts AS t_ts
    FROM events_ts e -- Target event (the one we're attributing)
    JOIN events_enriched t -- Historical event (the one we're checking for traffic channel)
      ON t.client_id = e.client_id
     AND t.ts BETWEEN e.ts - INTERVAL '7 days' AND e.ts
)
SELECT
    a.event_id,
    a.client_id,
    a.page_url,
    a.user_agent,
    a.event_name,
    a.timestamp::timestamp as timestamp,
    a.session_index,
    a.session_id,
    b._kx, b.bxid, b.locale, b.utm_campaign, b.utm_content, b.utm_medium, b.utm_source,
    b.utm_term, b.gclid, b.gad_source, b.gbraid, b._gl, b.fbclid, b.msclkid,
    b.irclickid, b.irgwc, b.iradid, b.im_ref, b.oid, b.affid, b.sub1, b.sub2, b.sub3,
    b.clickid, b.sharedid, b.sfdr_ptcid, b.sfdr_hash, b.amp_device_id, b.traffic_channel,
    -- Attribution logic: Aggregating traffic channels from the window
    (ARRAY_AGG(w.traffic_channel ORDER BY w.t_ts ASC))[1] AS first_traffic_channel_last_7d,
    (ARRAY_AGG(w.traffic_channel ORDER BY w.t_ts DESC))[1] AS latest_traffic_channel_last_7d
FROM enrich_session_and_event_id a
LEFT JOIN events_with_extracted_url_params b
    ON a.event_id = b.event_id
LEFT JOIN event_windows w
    ON w.e_id = a.event_id
GROUP BY
    a.event_id, a.client_id, a.page_url, a.user_agent, a.event_name,a.timestamp, a.session_index, a.session_id,
    b._kx, b.bxid, b.locale, b.utm_campaign, b.utm_content, b.utm_medium, b.utm_source,
    b.utm_term, b.gclid, b.gad_source, b.gbraid, b._gl, b.fbclid, b.msclkid,
    b.irclickid, b.irgwc, b.iradid, b.im_ref, b.oid, b.affid, b.sub1, b.sub2, b.sub3,
    b.clickid, b.sharedid, b.sfdr_ptcid, b.sfdr_hash, b.amp_device_id, b.traffic_channel
ORDER BY a.client_id, a.timestamp::timestamp)
